<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single-File CSV Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS STYLES --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        #container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #007bff;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        input[type="file"], button, select, input[type="text"] {
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        hr {
            margin: 20px 0;
            border: 0;
            border-top: 1px solid #ccc;
        }
        .card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        #dataTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #dataTable th, #dataTable td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }
        #dataTable th {
            background-color: #e9ecef;
            color: #333;
        }
        .anomaly {
            background-color: #ffcccc !important; /* Highlight anomalous rows */
            font-weight: bold;
        }
        .status {
            margin-top: 10px;
            font-weight: bold;
        }
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for the chart */
            width: 100%;
            margin-top: 15px;
        }
        #statsOutput div {
            padding: 5px 0;
        }
        #filterControls label {
            font-weight: bold;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>üìä Single-File CSV Data Analyzer</h1>
        <p>Upload a CSV file to begin analysis, filtering, and visualization.</p>

        <input type="file" id="csvFile" accept=".csv">

        <hr>

        <div id="analysisSection" style="display: none;">
            
            <div class="card">
                <h2>üìà Column Statistics & Anomalies</h2>
                <div id="statsOutput"></div>
            </div>

            <div class="card">
                <h2>‚öôÔ∏è Data Filtering</h2>
                <div id="filterControls">
                    <label for="filterColumn">Filter Column:</label>
                    <select id="filterColumn"></select>
                    <label for="filterValue">Value/Operator (e.g., > 100):</label>
                    <input type="text" id="filterValue" placeholder="Enter value or operator (e.g. 50 or > 50)">
                    <button onclick="applyFilter()">Apply Filter</button>
                    <button onclick="resetData()">Reset Data</button>
                </div>
                <p id="filterStatus" class="status"></p>
            </div>

            <div class="card">
                <h2>üñºÔ∏è Data Visualization</h2>
                <label for="chartColumn">Select Column for Chart:</label>
                <select id="chartColumn" onchange="createChart()"></select>
                <div class="chart-container">
                    <canvas id="dataChart"></canvas>
                </div>
            </div>
            
            <div class="card table-card">
                <h2>üìã Filtered Data Table</h2>
                <table id="dataTable"></table>
            </div>
        </div>
    </div>
    
    <script>
        /* --- JAVASCRIPT LOGIC --- */
        let rawData = [];
        let filteredData = [];
        let headers = [];
        let chartInstance = null;
        const Z_SCORE_THRESHOLD = 3; // Threshold for anomaly detection

        document.getElementById('csvFile').addEventListener('change', handleFileUpload);

        /**
         * Step 1: Handle File Upload and Parsing
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
                document.getElementById('analysisSection').style.display = 'block';
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            rawData = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                // Simple regex to handle quoted commas, but relies on no escaped quotes within fields
                const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length !== headers.length) continue; // Skip malformed rows
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                });
                rawData.push(row);
            }
            
            filteredData = [...rawData];
            updateFilterControls();
            updateChartControls();
            displayStatsAndAnomalies();
            displayTable(filteredData);
            createChart(); 
        }

        /**
         * Step 2: Data Statistics & Anomaly Detection (Z-score)
         */
        function calculateStats(values) {
            const N = values.length;
            if (N === 0) return null;
            const sum = values.reduce((a, b) => a + b, 0);
            const mean = sum / N;
            const squaredDifferences = values.map(v => (v - mean) ** 2);
            const variance = squaredDifferences.reduce((a, b) => a + b, 0) / N;
            const stdDev = Math.sqrt(variance);
            
            return { N, mean, stdDev, min: Math.min(...values), max: Math.max(...values) };
        }
        
        function displayStatsAndAnomalies() {
            const statsOutput = document.getElementById('statsOutput');
            statsOutput.innerHTML = '';
            let statsHTML = '';
            
            const numericHeaders = getNumericHeaders();
            const anomalyMap = new Map(); 

            // Clear previous anomaly flags
            rawData.forEach(row => row.isAnomaly = false);

            numericHeaders.forEach(header => {
                const values = rawData.map(row => parseFloat(row[header])).filter(v => !isNaN(v));
                const stats = calculateStats(values);
                if (!stats) return;

                let anomalies = [];
                if (stats.stdDev > 0) {
                    values.forEach((value, index) => {
                        const zScore = (value - stats.mean) / stats.stdDev;
                        if (Math.abs(zScore) > Z_SCORE_THRESHOLD) {
                            anomalies.push({ rowIndex: index, value: value, zScore: zScore.toFixed(2) });
                            // Flag the row in rawData
                            rawData[index].isAnomaly = true;
                        }
                    });
                }
                anomalyMap.set(header, anomalies);

                statsHTML += `
                    <div>
                        <strong>Column: ${header}</strong>
                        <ul>
                            <li>**Count:** ${stats.N}</li>
                            <li>**Mean:** ${stats.mean.toFixed(2)}</li>
                            <li>**Standard Deviation (SD):** ${stats.stdDev.toFixed(2)}</li>
                            <li>**Min:** ${stats.min}</li>
                            <li>**Max:** ${stats.max}</li>
                            <li>**Anomalous Records (Z-score > ${Z_SCORE_THRESHOLD}):** ${anomalies.length}</li>
                        </ul>
                    </div>
                `;
            });

            statsOutput.innerHTML = statsHTML;
            displayTable(filteredData); // Refresh table to show highlights
        }

        /**
         * Step 3: Filtering Logic
         */
        function updateFilterControls() {
            const filterColumnSelect = document.getElementById('filterColumn');
            filterColumnSelect.innerHTML = '<option value="">-- Select Column --</option>';
            headers.forEach(header => {
                filterColumnSelect.innerHTML += `<option value="${header}">${header}</option>`;
            });
        }

        function applyFilter() {
            const column = document.getElementById('filterColumn').value;
            const filterText = document.getElementById('filterValue').value.trim();
            const status = document.getElementById('filterStatus');

            if (!column || !filterText) {
                status.textContent = 'Please select a column and enter a filter value.';
                status.style.color = '#dc3545'; 
                return;
            }

            let newFilteredData = rawData.filter(row => {
                const value = row[column];
                
                // Numerical comparison (e.g., > 100, < 50)
                const numericMatch = filterText.match(/^([<>=]+)\s*(-?\d+(\.\d+)?)$/);
                if (numericMatch) {
                    const operator = numericMatch[1];
                    const compareValue = parseFloat(numericMatch[2]);
                    const cellValue = parseFloat(value);
                    
                    if (isNaN(cellValue)) return false; 

                    switch (operator) {
                        case '>': return cellValue > compareValue;
                        case '<': return cellValue < compareValue;
                        case '=': return cellValue === compareValue;
                        case '>=': return cellValue >= compareValue;
                        case '<=': return cellValue <= compareValue;
                        default: return false;
                    }
                }
                
                // Simple text/substring match
                return String(value).toLowerCase().includes(filterText.toLowerCase());
            });

            filteredData = newFilteredData;
            displayTable(filteredData);
            createChart(); 
            
            status.textContent = `Filter applied: ${filteredData.length} records remain.`;
            status.style.color = '#28a745'; 
        }
        
        function resetData() {
            filteredData = [...rawData];
            displayTable(filteredData);
            createChart();
            document.getElementById('filterValue').value = '';
            document.getElementById('filterStatus').textContent = 'Filter reset. Showing all data.';
            document.getElementById('filterStatus').style.color = '#28a745';
        }

        /**
         * Step 4: Data Table Display
         */
        function displayTable(data) {
            const table = document.getElementById('dataTable');
            table.innerHTML = ''; 

            if (data.length === 0) {
                table.innerHTML = '<caption>No data to display.</caption>';
                return;
            }

            // Create Table Header
            let headerRow = '<tr>';
            headers.forEach(header => {
                headerRow += `<th>${header}</th>`;
            });
            headerRow += '</tr>';
            table.innerHTML += headerRow;

            // Create Table Body
            data.forEach(row => {
                // Check the anomaly flag set during the stats calculation
                let rowHTML = `<tr class="${row.isAnomaly ? 'anomaly' : ''}">`;
                headers.forEach(header => {
                    rowHTML += `<td>${row[header]}</td>`;
                });
                rowHTML += '</tr>';
                table.innerHTML += rowHTML;
            });
        }
        
        /**
         * Step 5: Chart.js Visualization
         */
        function getNumericHeaders() {
            // Check if at least 70% of the first 10 rows are numeric
            return headers.filter(header => {
                const sample = rawData.slice(0, 10).map(row => parseFloat(row[header])).filter(v => !isNaN(v));
                return sample.length >= 7; 
            });
        }

        function updateChartControls() {
            const chartColumnSelect = document.getElementById('chartColumn');
            chartColumnSelect.innerHTML = '<option value="">-- Select Column --</option>';
            const numericHeaders = getNumericHeaders();
            
            numericHeaders.forEach(header => {
                chartColumnSelect.innerHTML += `<option value="${header}">${header}</option>`;
            });
            // Set a default selection
            if (numericHeaders.length > 0) {
                chartColumnSelect.value = numericHeaders[0];
            }
        }
        
        function createChart() {
            const column = document.getElementById('chartColumn').value;
            const canvas = document.getElementById('dataChart');
            const ctx = canvas.getContext('2d');

            if (chartInstance) {
                chartInstance.destroy(); 
            }
            if (!column || filteredData.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                return;
            }
            
            const values = filteredData.map(row => parseFloat(row[column])).filter(v => !isNaN(v));
            if (values.length === 0) return;

            let chartType = 'line';
            let labels = [];
            let data = values;

            if (values.length < 50 && values.length > 0) { 
                 // Bar chart on unique counts for small datasets
                 const counts = values.reduce((acc, val) => {
                    acc[val] = (acc[val] || 0) + 1;
                    return acc;
                }, {});
                labels = Object.keys(counts).sort((a, b) => a - b);
                data = labels.map(key => counts[key]);
                chartType = 'bar';
            } else {
                 // Line chart showing value progression
                 labels = values.map((_, i) => i + 1);
                 chartType = 'line';
            }

            chartInstance = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Values for ${column} (${filteredData.length} records)`,
                        data: data,
                        backgroundColor: chartType === 'bar' ? 'rgba(0, 123, 255, 0.5)' : 'rgba(0, 123, 255, 0.2)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1,
                        pointRadius: chartType === 'line' ? 0 : 3 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: chartType === 'bar' ? true : false,
                            title: {
                                display: true,
                                text: chartType === 'bar' ? 'Frequency' : column
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: chartType === 'bar' ? 'Unique Values' : 'Record Index'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: `Visualization of ${column} (Type: ${chartType.toUpperCase()})`
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>